<div class="page" (click)="onPageClick()">
  <!-- Navigation bar -->
  <nav class="navbar">
    <a routerLink="/" class="brand">
      <div class="logo">T</div>
      <span class="brandName">Taskify</span>
    </a>
    <div class="navTabs">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }" class="navTab">Home</a>
      <a routerLink="/boards" routerLinkActive="active" class="navTab">Boards</a>
      <a routerLink="/features" routerLinkActive="active" class="navTab">Features</a>
      <a routerLink="/about" routerLinkActive="active" class="navTab">About</a>
    </div>
    <div class="navActions">
      <div class="profileWrap">
        <button
          class="profileIcon"
          type="button"
          aria-label="Profile"
          (click)="toggleProfileMenu()"
        >
          <span class="profileAvatar">{{ userInitial }}</span>
        </button>
        <div *ngIf="showProfileMenu" class="profileDropdown" (click)="$event.stopPropagation()">
          <div class="profileDropdownHead">
            <span class="profileDropdownAvatar">{{ userInitial }}</span>
            <div class="profileDropdownInfo">
              <span class="profileName">{{ userDisplayName }}</span>
              <span class="profileEmail">{{ userEmail }}</span>
            </div>
          </div>
          <div class="profileDropdownDivider"></div>
          <a routerLink="/boards" class="profileDropdownItem" (click)="closeProfileMenu()">My boards</a>
          <button type="button" class="profileDropdownItem profileDropdownLogout" (click)="logout()">
            Log out
          </button>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn ghost" type="button" (click)="openCreateModal()">
        + New Board
      </button>
    </div>
  </header>

  <section class="section">
    <div class="sectionHead">
      <div>
        <h2>Your Boards</h2>
        <p class="muted">Showing boards created by {{ userDisplayName }}.</p>
      </div>

      <div class="status">
        <span *ngIf="isLoading" class="badge">Loading</span>
        <span *ngIf="useDemoData" class="badge warn">Demo mode</span>
        <span *ngIf="!isLoading && !useDemoData && !apiError && !errorMsg" class="badge ok">Connected</span>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="state-text">
      Loading boards...
    </div>

    <app-error-banner
      *ngIf="!isLoading && errorMsg"
      title="Backend unreachable"
      [message]="errorMsg"
      hint="Make sure the backend server is running (port 8080) or configure API base URL for deployment."
      [canRetry]="true"
      (retry)="loadProjects()"
      (dismiss)="errorMsg = ''"
    ></app-error-banner>

    <!-- Empty -->
    <div *ngIf="!isLoading && !errorMsg && (!projects || projects.length === 0)" class="state-text">
      No boards yet. Create your first board to get started.
    </div>

    <!-- Grid -->
    <div *ngIf="!isLoading && !errorMsg && projects?.length" class="grid">
      <!-- Project Cards -->
      <button
        class="card"
        type="button"
        *ngFor="let project of projects; let i = index"
        (click)="openBoard(project.id)"
      >
        <div class="cardColorBar" [style.background]="getProjectColor(i)"></div>
        <div class="cardBody">
          <div class="cardTop">
            <div class="avatar" [style.background]="getProjectColor(i)">
              {{ (project.name || 'B').slice(0,1).toUpperCase() }}
            </div>
            <div class="menuWrap" (click)="$event.stopPropagation()">
              <button class="menuIcon" (click)="toggleBoardMenu(project.id, $event)">⋮</button>

              <div class="boardMenu" *ngIf="openMenuProjectId === project.id">
                <button class="boardMenuItem" (click)="openBoardFromMenu(project.id, $event)">Open</button>
                <button class="boardMenuItem" (click)="openRenameModal(project, $event)">Rename</button>
                <div class="boardMenuDivider"></div>
                <button class="boardMenuItem danger" (click)="openDeleteModal(project, $event)">Delete</button>
              </div>
            </div>
          </div>

          <!-- Delete action -->
          <button
            class="iconBtn"
            type="button"
            title="Delete board"
            aria-label="Delete board"
            (click)="$event.stopPropagation(); openDeleteModal(project)"
          >
            ⋮
          </button>
        </div>

        <div class="title">{{ project.name }}</div>
        <div class="desc">{{ project.description || 'No description yet' }}</div>
      </button>

      <!-- Create tile (keep it) -->
      <button class="card create" type="button" (click)="openCreateModal()">
        <div class="plus">+</div>
        <div class="title">Create new board</div>
        <div class="desc">Start with a blank board</div>
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footerInner">
      <div class="footerBrand">Taskify</div>
      <div class="footerLinks">
        <a routerLink="/features">Features</a>
        <a routerLink="/about">About</a>
        <a href="#">Contact</a>
        <a href="#">Privacy</a>
      </div>
      <p class="footerCopy">© {{ currentYear }} Taskify. Your project management tool.</p>
    </div>
  </footer>

  <!-- CREATE MODAL -->
  <div *ngIf="showCreateModal" class="modalBackdrop" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modalHead">
        <div>
          <h3>Create new board</h3>
          <p class="muted">Add a name and optional description.</p>
        </div>
        <button class="iconBtn" type="button" (click)="closeCreateModal()">✕</button>
      </div>

      <div class="modalBody">
        <label class="field">
          <span>Name</span>
          <input [(ngModel)]="newBoardName" placeholder="e.g., Sprint Planning" />
        </label>

        <label class="field">
          <span>Description</span>
          <textarea [(ngModel)]="newBoardDesc" rows="3" placeholder="Short summary..."></textarea>
        </label>
      </div>

      <div class="modalFoot">
        <button class="btn ghost" type="button" (click)="closeCreateModal()">Cancel</button>
        <button class="btn primary" type="button" (click)="createNewBoard()"
          [disabled]="creating || !newBoardName.trim()">
          {{ creating ? 'Creating...' : 'Create' }}
        </button>
      </div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  <div *ngIf="showDeleteModal" class="modalBackdrop" (click)="closeDeleteModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modalHead">
        <div>
          <h3>Delete board</h3>
          <p class="muted">This action cannot be undone.</p>
        </div>
        <button class="iconBtn" type="button" (click)="closeDeleteModal()">✕</button>
      </div>

      <div class="modalBody">
        <p>
          Are you sure you want to delete
          <b>{{ projectToDelete?.name }}</b>?
        </p>
      </div>

      <div class="modalFoot">
        <button class="btn ghost" type="button" (click)="closeDeleteModal()">Cancel</button>
        <button class="btn danger" type="button" (click)="confirmDeleteBoard()"
          [disabled]="deleting">
          {{ deleting ? 'Deleting...' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Rename Board Modal -->
  <div class="modalBackdrop" *ngIf="renameModalOpen" (click)="closeRenameModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modalHeader">
        <h3>Rename board</h3>
        <button class="closeBtn" (click)="closeRenameModal()">✕</button>
      </div>

      <div class="modalBody">
        <label class="fieldLabel">Board Name</label>
        <input class="input" [(ngModel)]="renameName" placeholder="Enter board name" />

        <label class="fieldLabel" style="margin-top: 10px;">Description</label>
        <textarea class="textarea" [(ngModel)]="renameDesc" placeholder="Optional description"></textarea>
      </div>

      <div class="modalFooter">
        <button class="btn secondary" (click)="closeRenameModal()">Cancel</button>
        <button class="btn danger" (click)="saveRename()">Save</button>
      </div>
    </div>
  </div>
</div>
